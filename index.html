<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ecem & melih</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .hidden { display: none; }
        
        #identityOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .identity-card { background: #1e293b; padding: 40px; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); text-align: center; border: 1px solid #334155; max-width: 450px; }
        .identity-btn { width: 200px; padding: 15px; margin: 10px; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 1.1rem; transition: 0.3s; color: white; }
        .btn-ecem { background: #ec4899; }
        .btn-melih { background: #3b82f6; }
        .identity-btn:hover { transform: translateY(-5px); filter: brightness(1.2); }

        #terminal { font-family: monospace; background: black; padding: 25px; border-radius: 15px; text-align: left; width: 100%; max-width: 600px; margin-top: 50px; border: 1px solid #1e293b; color: #10b981; line-height: 1.6; }

        .birthday-container { display: flex; justify-content: space-between; width: 100%; max-width: 1100px; margin-bottom: 25px; gap: 20px; }
        .bday-box { flex: 1; background: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 20px; text-align: center; border: 1px solid #334155; position: relative; }
        
        .ecem-special { border: 1px solid #ec4899; background: linear-gradient(145deg, #1e293b, #251628); }
        .ecem-special h4 { color: #f472b6; margin: 0; font-size: 0.85rem; letter-spacing: 1px; }
        .glow-text { color: #ec4899; font-weight: bold; animation: softGlow 3s ease-in-out infinite alternate; }
        
        @keyframes softGlow {
            from { text-shadow: 0 0 2px #fff, 0 0 5px #ec4899; }
            to { text-shadow: 0 0 4px #fff, 0 0 10px #ec4899; }
        }

        .melih-box h4 { color: #60a5fa; margin: 0; font-size: 0.85rem; letter-spacing: 1px; }
        .timer-val { font-size: 1.3rem; font-weight: bold; display: block; margin-top: 5px; }

        .mood-section { margin-bottom: 35px; text-align: center; width: 100%; }
        .mood-container { display: flex; justify-content: center; gap: 25px; flex-wrap: wrap; }
        .mood-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; width: 70px; }
        .mood-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; }
        .mood-btn { cursor: pointer; font-size: 2.2rem; filter: grayscale(100%); transition: 0.3s; padding: 5px; }
        .mood-btn.active { filter: grayscale(0%); transform: scale(1.2); }
        .user-tag { font-size: 0.7rem; font-weight: bold; margin-top: 5px; min-height: 18px; display: flex; gap: 5px; }
        .tag-e { color: #ec4899; }
        .tag-m { color: #3b82f6; }

        .main-panel { display: flex; gap: 20px; width: 100%; max-width: 1400px; justify-content: center; flex-wrap: wrap; }
        .column-box { flex: 1; min-width: 300px; background: #1e293b; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); border: 1px solid #334155; display: flex; flex-direction: column; }

        h3 { margin-top: 0; border-bottom: 1px solid #334155; padding-bottom: 10px; text-align: center; }
        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #475569; background: #0f172a; color: white; margin-bottom: 10px; box-sizing: border-box; }
        .btn { border: none; padding: 10px; color: white; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; }
        
        .scroll-area { flex-grow: 1; max-height: 250px; overflow-y: auto; margin-top: 10px; }
        .item-card { background: #0f172a; padding: 10px; border-radius: 10px; margin-bottom: 8px; font-size: 0.85rem; border-left: 3px solid #3b82f6; transition: 0.2s; }
        
        .spotify-slot { background: #0f172a; border-radius: 12px; padding: 5px; margin-bottom: 10px; border: 1px solid #334155; cursor: pointer; }
        .slot-label { font-size: 0.65rem; font-weight: bold; margin-left: 5px; margin-bottom: 3px; display: block; }
        .song-history-item { font-size: 0.75rem; padding: 8px; border-bottom: 1px solid #334155; cursor: pointer; color: #94a3b8; }
        .admin-trigger { position: fixed; bottom: 0; right: 0; width: 30px; height: 30px; cursor: pointer; opacity: 0; z-index: 9999; }
        
        #welcome-text { color: #94a3b8; font-style: italic; margin-bottom: 15px; font-size: 0.9rem; line-height: 1.4; }

        .chat-container { display: flex; flex-direction: column; height: 350px; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; background: #0f172a; border-radius: 10px; margin-bottom: 10px; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 15px; font-size: 0.85rem; position: relative; }
        .msg-ecem { align-self: flex-start; background: #ec4899; color: white; border-bottom-left-radius: 2px; }
        .msg-melih { align-self: flex-end; background: #3b82f6; color: white; border-bottom-right-radius: 2px; }
        .chat-input-row { display: flex; gap: 5px; position: relative; }
        .quick-msg-btn { background: #334155; border: none; color: white; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.5rem; }
        .quick-menu { position: absolute; bottom: 50px; left: 0; background: #1e293b; border: 1px solid #334155; border-radius: 10px; padding: 10px; display: none; grid-template-columns: repeat(2, 1fr); gap: 5px; z-index: 100; width: 250px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .quick-item { font-size: 0.75rem; padding: 5px; background: #0f172a; border-radius: 5px; cursor: pointer; text-align: center; }
        .quick-item:hover { background: #334155; }

        #map { height: 400px; border-radius: 20px; border: 1px solid #334155; margin-top: 25px; width: 100%; max-width: 1200px; z-index: 1; }
        .beating-heart { display: inline-block; animation: heartBeat 1.2s infinite; font-size: 26px; filter: drop-shadow(0 0 5px red); }
        @keyframes heartBeat { 0% { transform: scale(1); } 15% { transform: scale(1.3); } 30% { transform: scale(1); } }
        .map-label { background: rgba(15, 23, 42, 0.9); border: 1px solid #3b82f6; color: white; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-top: 5px; display: inline-block; }
.love-card-wrapper {
    width: 100%;
    display: flex;
    justify-content: center;
    margin: 20px 0 30px 0;
}

.love-card {
    background: linear-gradient(135deg, #db2777 0%, #ec4899 50%, #f472b6 100%);
    padding: 25px 50px;
    border-radius: 50px;
    box-shadow: 0 0 25px rgba(236, 72, 153, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.3);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s;
    border: 2px solid rgba(255, 255, 255, 0.4);
    min-width: 350px;
    text-align: center;
    animation: floating 3s infinite ease-in-out;
}

.love-card:active { transform: scale(0.95); }

.love-content {
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    transition: opacity 0.3s;
}

.star-decor {
    position: absolute;
    color: white;
    opacity: 0.6;
    font-size: 14px;
    animation: blink 2s infinite;
}

@keyframes floating {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes blink {
    0%, 100% { opacity: 1; scale: 1; }
    50% { opacity: 0.3; scale: 1.3; }
}
    </style>
</head>
<body>

    <div id="identityOverlay">
        <div class="identity-card">
            <h2 id="love-title" style="margin-bottom: 10px; color: #94a3b8;">HoÅŸ Geldin</h2>
            <p id="welcome-text">LÃ¼tfen profilini seÃ§erek baÅŸla...</p>
            <button class="identity-btn btn-ecem" onclick="setUser('ecem')">ECEM</button>
            <button class="identity-btn btn-melih" onclick="setUser('melih')">MELÄ°H</button>
        </div>
    </div>

    <div id="step1" class="hidden" style="text-align:center; margin-top:100px;">
        <h1 style="letter-spacing: 3px;">ecem & melih</h1>
        <button class="btn" style="width:180px; background:#3b82f6;" onclick="startReset()">SÄ°STEME GÄ°R</button>
    </div>

    <div id="terminal" class="hidden"></div>

    <div id="step3" class="hidden" style="width:100%; max-width:1400px;">
        
       <div class="birthday-container">
    <div class="bday-box ecem-special">
        <h4>ğŸº ECEM'Ä°N DOÄUM GÃœNÃœ ğŸº</h4>
        <span id="ecemTimer" class="timer-val glow-text">-- : -- : -- : --</span>
        <div id="weather-ecem" class="weather-box">
            <div id="weather-ecem-main" style="font-weight: bold; color: #ec4899;"></div>
            <div id="weather-ecem-desc" style="color: #94a3b8; font-size: 0.7rem;"></div>
        </div>
    </div>

    <div style="display: flex; align-items: center; justify-content: center; min-width: 100px;">
        <img src="fenerbahÃ§e.jpg" alt="Amblem" style="height: 80px; width: auto; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2));">
    </div>

    <div class="bday-box melih-box">
        <h4>ğŸ‚ MELÄ°H'Ä°N DOÄUM GÃœNÃœ ğŸ‚</h4>
        <span id="melihTimer" class="timer-val" style="color:#3b82f6;">-- : -- : -- : --</span>
        <div id="weather-melih" class="weather-box">
            <div id="weather-melih-main" style="font-weight: bold; color: #3b82f6;"></div>
            <div id="weather-melih-desc" style="color: #94a3b8; font-size: 0.7rem;"></div>
        </div>
    </div>
</div>

<div class="love-card-wrapper">
    <div class="love-card" onclick="showLoveWord()">
        <div class="love-content">
            <span class="sparkle">âœ¨</span>
            <span id="love-text-display">Sana Bir MesajÄ±m Var... (TÄ±kla)</span>
            <span class="sparkle">âœ¨</span>
        </div>
        <div class="star-decor" style="top:10%; left:5%;">â˜…</div>
        <div class="star-decor" style="bottom:10%; right:5%;">â˜…</div>
    </div>
</div>

<div class="mood-section">
            <div class="mood-container">
                <div class="mood-wrapper"><span class="mood-label">Kahve</span><span class="mood-btn" id="m-coffee" onclick="selectMood('coffee')">â˜•</span><div class="user-tag" id="tag-coffee"></div></div>
                <div class="mood-wrapper"><span class="mood-label">Oyun</span><span class="mood-btn" id="m-game" onclick="selectMood('game')">ğŸ®</span><div class="user-tag" id="tag-game"></div></div>
                <div class="mood-wrapper"><span class="mood-label">Uyku</span><span class="mood-btn" id="m-sleep" onclick="selectMood('sleep')">ğŸ˜´</span><div class="user-tag" id="tag-sleep"></div></div>
                <div class="mood-wrapper"><span class="mood-label">Mutlu</span><span class="mood-btn" id="m-happy" onclick="selectMood('happy')">ğŸ˜Š</span><div class="user-tag" id="tag-happy"></div></div>
                <div class="mood-wrapper"><span class="mood-label">Ders</span><span class="mood-btn" id="m-study" onclick="selectMood('study')">ğŸ“š</span><div class="user-tag" id="tag-study"></div></div>
                <div class="mood-wrapper"><span class="mood-label">MÃ¼zik</span><span class="mood-btn" id="m-music" onclick="selectMood('music')">ğŸ§</span><div class="user-tag" id="tag-music"></div></div>
                <div class="mood-wrapper"><span class="mood-label">Yorgun</span><span class="mood-btn" id="m-tired" onclick="selectMood('tired')">ğŸ˜«</span><div class="user-tag" id="tag-tired"></div></div>
                <div class="mood-wrapper"><span class="mood-label">DÄ±ÅŸarda</span><span class="mood-btn" id="m-out" onclick="selectMood('out')">â˜ï¸</span><div class="user-tag" id="tag-out"></div></div>
                <div class="mood-wrapper"><span class="mood-label">Yemek</span><span class="mood-btn" id="m-food" onclick="selectMood('food')">ğŸ•</span><div class="user-tag" id="tag-food"></div></div>
                <div class="mood-wrapper"><span class="mood-label">Dizi</span><span class="mood-btn" id="m-movie" onclick="selectMood('movie')">ğŸ¬</span><div class="user-tag" id="tag-movie"></div></div>
            </div>
        </div>

        <div class="main-panel">
            <div class="column-box">
                <h3>ğŸµ ÅarkÄ± PaylaÅŸÄ±mÄ±</h3>
                <div id="streakDisplay" style="background:#334155; color:white; border-radius:20px; padding:4px 12px; font-weight:bold; font-size:0.8rem; align-self:center; margin-bottom:15px;">GÃ¼ncel Seri ğŸ”¥ 3</div>
                <span class="slot-label" style="color:#ec4899;">ECEM</span>
                <div id="spotify-ecem" class="spotify-slot" onclick="copySong('ecem')">HenÃ¼z ÅŸarkÄ± eklenmedi.</div>
                <span class="slot-label" style="color:#3b82f6;">MELÄ°H</span>
                <div id="spotify-melih" class="spotify-slot" onclick="copySong('melih')">HenÃ¼z ÅŸarkÄ± eklenmedi.</div>
                <input type="text" id="songInput" placeholder="Spotify Linki YapÄ±ÅŸtÄ±r...">
                <button class="btn" style="background:#1db954;" onclick="updateSong()">PaylaÅŸ</button>
                <div class="scroll-area" id="songHistory" style="max-height: 100px;"></div>
            </div>

            <div class="column-box">
                <h3>ğŸ’¬ Sohbet</h3>
                <div class="chat-container">
                    <div class="chat-messages" id="chatBox"></div>
                    <div class="chat-input-row">
                        <button class="quick-msg-btn" onclick="toggleQuickMenu()">+</button>
                        <div class="quick-menu" id="quickMenu">
                            <div class="quick-item" onclick="sendQuick('GÃ¼naydÄ±nn â˜€ï¸')">GÃ¼naydÄ±n â˜€ï¸</div>
                            <div class="quick-item" onclick="sendQuick('Ä°yi geceler âœ¨')">Ä°yi geceler âœ¨</div>
                            <div class="quick-item" onclick="sendQuick('Naber? ğŸ˜Š')">Naber? ğŸ˜Š</div>
                            <div class="quick-item" onclick="sendQuick('Seni seviyorum â¤ï¸')">Seni seviyorum â¤ï¸</div>
                            <div class="quick-item" onclick="sendQuick('Ã–zledim.. ğŸ¥º')">Ã–zledim.. ğŸ¥º</div>
                            <div class="quick-item" onclick="sendQuick('MÃ¼sait misin?')">MÃ¼sait misin?</div>
                            <div class="quick-item" onclick="sendQuick('ArayayÄ±m mÄ±? ğŸ“')">ArayayÄ±m mÄ±? ğŸ“</div>
                            <div class="quick-item" onclick="sendQuick('Yemek yiyorum ğŸ•')">Yemek yiyorum ğŸ•</div>
                            <div class="quick-item" onclick="sendQuick('DÄ±ÅŸarÄ± Ã§Ä±kÄ±yorum â˜ï¸')">DÄ±ÅŸarÄ± Ã§Ä±kÄ±yorum â˜ï¸</div>
                            <div class="quick-item" onclick="sendQuick('Eve geldim âœ…')">Eve geldim âœ…</div>
                            <div class="quick-item" onclick="sendQuick('Uykum geldi ğŸ˜´')">Uykum geldi ğŸ˜´</div>
                            <div class="quick-item" onclick="sendQuick('Harika! ğŸŒŸ')">Harika! ğŸŒŸ</div>
                            <div class="quick-item" onclick="sendQuick('CanÄ±m sÄ±kÄ±ldÄ± ğŸ˜«')">CanÄ±m sÄ±kÄ±ldÄ± ğŸ˜«</div>
                            <div class="quick-item" onclick="sendQuick('Ders Ã§alÄ±ÅŸÄ±yorum ğŸ“š')">Ders Ã§alÄ±ÅŸÄ±yorum ğŸ“š</div>
                            <div class="quick-item" onclick="sendQuick('Oyun oynuyorum ğŸ®')">Oyun oynuyorum ğŸ®</div>
                            <div class="quick-item" onclick="sendQuick('ÅarkÄ± Ã§ok iyi! ğŸ§')">ÅarkÄ± Ã§ok iyi! ğŸ§</div>
                            <div class="quick-item" onclick="sendQuick('Birazdan gelirim')">Birazdan gelirim</div>
                            <div class="quick-item" onclick="sendQuick('Dikkat et kendine â¤ï¸')">Dikkat et â¤ï¸</div>
                            <div class="quick-item" onclick="sendQuick('Ellerine saÄŸlÄ±k ğŸ˜‹')">Eline saÄŸlÄ±k ğŸ˜‹</div>
                            <div class="quick-item" onclick="sendQuick('GÃ¶rÃ¼ÅŸÃ¼rÃ¼z ğŸ‘‹')">GÃ¶rÃ¼ÅŸÃ¼rÃ¼z ğŸ‘‹</div>
                        </div>
                        <input type="text" id="chatInput" placeholder="Mesaj yaz..." style="margin-bottom:0;" onkeypress="if(event.key==='Enter')sendChatMessage()">
                        <button class="btn" style="background:#10b981; width:60px;" onclick="sendChatMessage()">></button>
                    </div>
                </div>
            </div>

            <div class="column-box">
                <h3>ğŸ“ Ortak Notlar</h3>
                <input type="text" id="noteInput" placeholder="Bir ÅŸeyler yaz..." onkeypress="if(event.key==='Enter')sendNote()">
                <button class="btn" style="background:#3b82f6;" onclick="sendNote()">GÃ¶nder</button>
                <div class="scroll-area" id="logList"></div>
            </div>

            <div class="column-box">
                <h3>ğŸ“ Planlar / Hedefler</h3>
                <input type="text" id="bucketInput" placeholder="Yeni bir plan ekle...">
                <button class="btn" style="background:#64748b;" onclick="addGoal()">Listeye Ekle</button>
                <div class="scroll-area" id="bucketList"></div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <div class="admin-trigger" onclick="adminLogin()"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx55yER9raJ_bJizwyZqU1IUcmRCnb-Do2oqfhokbLRxQQepMjf3x9V5RUy3htcsxgCcw/exec";
let selectedUser = localStorage.getItem('active_user') || null;
let lastSyncTimestamp = 0; // Sadece yeni verileri Ã§ekmek iÃ§in
let mainMap = null;

// Sayfa yÃ¼klendiÄŸinde baÅŸlat
window.onload = function() {
    if (selectedUser) {
        document.getElementById('identityOverlay').classList.add('hidden');
        document.getElementById('step1').classList.remove('hidden');
        refreshUI();
    }
    startBirthdayTimers();
    
    // VERÄ° Ã‡EKME HIZI: 1 Saniyeye dÃ¼ÅŸÃ¼rÃ¼ldÃ¼
    setInterval(syncVeri, 1000); 
};

async function syncVeri() {
    try {
        // Cache-busting (Bayat veri gelmemesi iÃ§in zaman damgasÄ± eklendi)
        const response = await fetch(SCRIPT_URL + "?action=read&t=" + new Date().getTime());
        if (!response.ok) return;
        const remoteData = await response.json();
        
        // Verileri hafÄ±zaya iÅŸle (Eski verinin Ã¼zerine yazar, anlÄ±k gÃ¼nceller)
        if(remoteData.chats) localStorage.setItem('chats', JSON.stringify(remoteData.chats.reverse()));
        if(remoteData.notes) localStorage.setItem('notes', JSON.stringify(remoteData.notes));
        if(remoteData.goals) localStorage.setItem('goals', JSON.stringify(remoteData.goals));
        
        // ÅarkÄ±larÄ± ve ModlarÄ± GÃ¼ncelle
        if(remoteData.songs) {
            remoteData.songs.forEach(s => localStorage.setItem('song_' + s.user, s.link));
        }

        remoteData.moods.forEach(m => {
            localStorage.setItem('mood_' + m.user, m.mood);
            localStorage.setItem('mood_time_' + m.user, m.time);
        });

        // ArayÃ¼zÃ¼ tazele
        refreshUI(); 
    } catch(e) { 
        console.warn("HÄ±z limiti veya baÄŸlantÄ± sorunu..."); 
    }
};

// Verileri Excel'den Ã‡ekme Fonksiyonu
async function syncVeri() {
    try {
        const response = await fetch(SCRIPT_URL + "?action=read");
        const remoteData = await response.json();
        
        // EÄŸer gelen veri boÅŸ deÄŸilse ve deÄŸiÅŸiklik varsa yerel hafÄ±zayÄ± gÃ¼ncelle
        if (remoteData) {
            if (remoteData.chats) localStorage.setItem('chats', JSON.stringify(remoteData.chats));
            if (remoteData.notes) localStorage.setItem('notes', JSON.stringify(remoteData.notes));
            if (remoteData.goals) localStorage.setItem('goals', JSON.stringify(remoteData.goals));
            if (remoteData.songs) {
                localStorage.setItem('song_history', JSON.stringify(remoteData.songs));
                // En son paylaÅŸÄ±lan ÅŸarkÄ±larÄ± slotlara yerleÅŸtir
                remoteData.songs.forEach(s => {
                    localStorage.setItem('song_' + s.user, s.link);
                });
            }
            if (remoteData.moods) {
                remoteData.moods.forEach(m => {
                    localStorage.setItem('mood_' + m.user, m.mood);
                    localStorage.setItem('mood_time_' + m.user, m.time);
                });
            }
            refreshUI(); // EkranÄ± gÃ¼ncelle
        }
    } catch (e) {
        console.error("Excel veri Ã§ekme hatasÄ±:", e);
    }
}

// Ekrandaki tÃ¼m listeleri yenileyen ana fonksiyon
function refreshUI() {
    displayChats();
    displayLogs();
    displayGoals();
    loadSongs();
    displaySongHistory();
    updateMoodUI();
    updateStreakUI();
}

// Veriyi Excel'e GÃ¶nderme (HÄ±zlandÄ±rÄ±lmÄ±ÅŸ)
async function sendToExcel(mesaj, tip, ekVeri = "") {
    const entry = { 
        user: selectedUser, 
        tip: tip, 
        mesaj: mesaj, 
        time: new Date().getTime(), 
        ek: ekVeri 
    };
    
    // UI'da anÄ±nda gÃ¶rmek iÃ§in yerel ekleme (Opsiyonel)
    try {
        await fetch(SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', // CORS engeline takÄ±lmamak iÃ§in
            cache: 'no-cache',
            body: JSON.stringify(entry) 
        });
    } catch (e) {
        console.log("GÃ¶nderim hatasÄ±");
    }
}

// Spotify SlotlarÄ±nÄ± DÃ¼zeltme
function loadSongs() {
    ['ecem', 'melih'].forEach(u => {
        const song = localStorage.getItem('song_' + u);
        const slot = document.getElementById('spotify-' + u);
        if(song && slot) {
            if (song.includes("spotify.com")) {
                const trackId = song.split("track/")[1]?.split("?")[0];
                if (trackId) {
                    slot.innerHTML = `<iframe src="https://open.spotify.com/embed/track/${trackId}" width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`;
                }
            } else {
                slot.innerText = "GeÃ§ersiz Spotify Linki";
            }
        }
    });
}

// Mesaj GÃ¶nderme Butonunu GÃ¼ncelleme
function sendChatMessage() {
    const val = document.getElementById('chatInput').value;
    if(!val) return;
    
    // AnlÄ±k olarak ekrana bas (Excel'den gelmesini bekleme)
    const chats = JSON.parse(localStorage.getItem('chats')) || [];
    chats.push({ msg: val, user: selectedUser, time: new Date().getTime() });
    localStorage.setItem('chats', JSON.stringify(chats));
    displayChats();
    
    document.getElementById('chatInput').value = "";
    sendToExcel(val, "Chat");
}
    
            if (selectedUser) {
                document.getElementById('identityOverlay').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');
                // Sayfa aÃ§Ä±lÄ±ÅŸÄ±nda her ÅŸeyi yÃ¼kle
                displayChats();
                displayLogs();
                displayGoals();
                loadSongs();
                displaySongHistory();
                updateMoodUI();
                updateStreakUI();
            }
            startBirthdayTimers();
            setInterval(syncVeri, 1000); // 1 saniyede bir kontrol et
async function updateWeather() {
    const locations = {
        ecem: { lat: 38.2312, lon: 27.9719, prefix: 'weather-ecem' },
        melih: { lat: 40.1885, lon: 29.0610, prefix: 'weather-melih' }
    };

    const weatherCodes = {
        0: { desc: "AÃ§Ä±k GÃ¶kyÃ¼zÃ¼", icon: "â˜€ï¸" },
        1: { desc: "Ã‡oÄŸunlukla AÃ§Ä±k", icon: "ğŸŒ¤ï¸" },
        2: { desc: "ParÃ§alÄ± Bulutlu", icon: "â›…" },
        3: { desc: "Bulutlu", icon: "â˜ï¸" },
        45: { desc: "Sisli", icon: "ğŸŒ«ï¸" },
        51: { desc: "Hafif Ã‡iseleme", icon: "ğŸŒ¦ï¸" },
        61: { desc: "Hafif YaÄŸmurlu", icon: "ğŸŒ§ï¸" },
        63: { desc: "YaÄŸmurlu", icon: "ğŸŒ§ï¸" },
        71: { desc: "Hafif KarlÄ±", icon: "â„ï¸" },
        95: { desc: "FÄ±rtÄ±na", icon: "âš¡" }
    };

    for (let person in locations) {
        try {
            const loc = locations[person];
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current_weather=true&timezone=auto`);
            const data = await res.json();
            
            const temp = Math.round(data.current_weather.temperature);
            const code = data.current_weather.weathercode;
            const info = weatherCodes[code] || { desc: "Bulutlu", icon: "â˜ï¸" };

            // Derece ve Ä°kon (Ãœst SatÄ±r)
            document.getElementById(`${loc.prefix}-main`).innerHTML = `${info.icon} ${temp}Â°C`;
            // Hava Durumu Metni (Alt SatÄ±r)
            document.getElementById(`${loc.prefix}-desc`).innerHTML = info.desc;
            
        } catch (e) {
            console.log("Hava durumu hatasÄ±");
        }
    }
}
function showLoveWord() {
    const words = [
        "Sen benim baÅŸÄ±ma gelen en gÃ¼zel ÅŸeysin. âœ¨", "Kalbimin tek sahibi sensin. â¤ï¸", "GÃ¶zlerinde dÃ¼nyayÄ± gÃ¶rÃ¼yorum. ğŸŒ",
        "Seni sevmek nefes almak gibi. ğŸŒ¬ï¸", "Ä°yi ki varsÄ±n sevgilim. ğŸ¥°", "Ruhumun eÅŸi sensin. ğŸ’", "Sen benim mucizemsin. ğŸª„",
        "GÃ¼lÃ¼ÅŸÃ¼n dÃ¼nyaya gÃ¼neÅŸ gibi doÄŸuyor. â˜€ï¸", "Sen benim evimsin. ğŸ¡", "HayatÄ±mÄ±n anlamÄ± sensin. ğŸ¯",
        "Seni her gÃ¼n bir Ã¶ncekinden daha Ã§ok seviyorum. ğŸ“ˆ", "Seninle geÃ§en her saniye bir hazine. ğŸ’",
        "Ellerini hiÃ§ bÄ±rakmak istemiyorum. ğŸ¤", "Sen benim ÅŸansÄ±msÄ±n. ğŸ€", "DÃ¼nyadaki en gÃ¼zel manzara senin yÃ¼zÃ¼n. ğŸ–¼ï¸",
        "Sen benim en tatlÄ± uykumsun. ğŸ’¤", "Kalbimin her kÃ¶ÅŸesi seninle dolu. ğŸ’–", "Seninle yaÅŸlanmak tek hayalim. ğŸ‘´ğŸ‘µ",
        "BakÄ±ÅŸlarÄ±nda kaybolmak istiyorum. ğŸŒŠ", "Sen benim huzurumsun. ğŸ§˜", "AÅŸkÄ±mÄ±z sonsuz olsun. â™¾ï¸",
        "Seninle her yer cennet bana. ğŸï¸", "Kalbim sadece senin iÃ§in atÄ±yor. ğŸ’“", "Sesin ruhuma en iyi gelen ilaÃ§. ğŸ’Š",
        "Sen benim gÃ¶kyÃ¼zÃ¼ndeki en parlak yÄ±ldÄ±zÄ±msÄ±n. â­", "VarlÄ±ÄŸÄ±n bana gÃ¼Ã§ veriyor. ğŸ’ª", "Sana olan sevgim kelimelere sÄ±ÄŸmÄ±yor. ğŸ“š",
        "Sen benim en gÃ¼zel rÃ¼yamÄ±n gerÃ§eÄŸe dÃ¶nÃ¼ÅŸmÃ¼ÅŸ halisin. ğŸ’­", "AÅŸkÄ±n beni her gÃ¼n yeniden doÄŸuruyor. ğŸ£",
        "Seni dÃ¼ÅŸÃ¼nmeden geÃ§en bir saniyem bile yok. â³", "HayatÄ±mÄ±n tÃ¼m renkleri seninle geldi. ğŸŒˆ",
        "Sen benim kahramanÄ±msÄ±n. ğŸ¦¸â€â™‚ï¸", "YanÄ±nda olduÄŸum her an kendimi buluyorum. ğŸ§©", "AÅŸkÄ±mÄ±z bir masal gibi. ğŸ“–",
        "Sana sarÄ±lmak dÃ¼nyadaki en gÃ¼venli yer. ğŸ«‚", "Kalbim seninle atÄ±yor, seninle duracak. ğŸ›‘",
        "Sen benim sonsuzluÄŸumsun. ğŸŒŒ", "GÃ¼zelliÄŸin karÅŸÄ±sÄ±nda bÃ¼yÃ¼leniyorum. ğŸ¤©", "Seninle her zorluk bir oyun gibi. ğŸ®",
        "Sen benim dualarÄ±mÄ±n cevabÄ±sÄ±n. ğŸ™", "AÅŸkÄ±n iÃ§imde bir kor gibi yanÄ±yor. ğŸ”¥", "Sen benim ruh eÅŸimsin. ğŸ”¥",
        "DÃ¼nyanÄ±n en ÅŸanslÄ± insanÄ±yÄ±m Ã§Ã¼nkÃ¼ seninleyim. ğŸ°", "Sen benim yaÅŸama sevincimsin. ğŸŒ±",
        "Her sabah seninle uyanma fikri bile huzur verici. â˜•", "Sen benim kalbimdeki en derin izsin. ğŸ‘£",
        "Seni sevmekten asla vazgeÃ§meyeceÄŸim. ğŸ›¡ï¸", "Sen benim bir tanemsin. â˜ï¸", "HayatÄ±ma dokunduÄŸun an her ÅŸey gÃ¼zelleÅŸti. ğŸª„",
        "Seninle her anÄ±m bir Ã¶mre bedel. â³", "AÅŸkÄ±n benim pusulam. ğŸ§­", "Sen benim her ÅŸeyimsin. ğŸ—ï¸",
        "GÃ¶zlerindeki Ä±ÅŸÄ±k yolumu aydÄ±nlatÄ±yor. ğŸ’¡", "Seninle gÃ¼lmek en bÃ¼yÃ¼k mutluluÄŸum. ğŸ˜‚",
        "Sen benim en gÃ¼zel ÅŸiirimsin. âœï¸", "Kalbimin ritmini deÄŸiÅŸtiren tek sensin. ğŸ¥",
        "Seni sevmek hayatÄ±mÄ±n en doÄŸru kararÄ±. âœ…", "Sen benim nefesimsin. ğŸ’¨", "Seninle olmak bir rÃ¼ya gibi. â˜ï¸",
        "Hayallerimin Ã¶tesindeki sevgilimsin. ğŸš€", "AÅŸkÄ±n bana her ÅŸeyi unutturuyor. ğŸ§ ",
        "Sen benim bitmeyen ÅŸarkÄ±msÄ±n. ğŸ¶", "Seninle geÃ§en Ã¶mÃ¼r en bÃ¼yÃ¼k Ã¶dÃ¼lÃ¼m. ğŸ†",
        "Sen benim dÃ¼nyamsÄ±n. ğŸ—ºï¸", "GÃ¼lÃ¼ÅŸÃ¼nde huzur bulduÄŸum tek insansÄ±n. ğŸ˜Š", "Sana olan aÅŸkÄ±m her an katlanÄ±yor. ğŸ“‚",
        "Sen benim en kÄ±ymetlimsin. ğŸ‘‘", "HayatÄ±mÄ±n en gÃ¼zel hikayesi seninle baÅŸladÄ±. ğŸ¬",
        "Sen benim ruhumun aynasÄ±sÄ±n. ğŸª", "Seni her halinle seviyorum. ğŸ’¯", "Sen benim canÄ±msÄ±n. ğŸ©¸",
        "YanÄ±nda zaman dursun istiyorum. â±ï¸", "AÅŸkÄ±n kalbimde Ã§iÃ§ekler aÃ§tÄ±rÄ±yor. ğŸŒ¸",
        "Sen benim sol yanÄ±m, en gÃ¼zel yanÄ±msÄ±n. ğŸ‘ˆ", "DÃ¼nyayÄ± seninle keÅŸfetmek istiyorum. ğŸŒ",
        "Sen benim en bÃ¼yÃ¼k aÅŸkÄ±msÄ±n. ğŸ³", "Seni dÃ¼ÅŸÃ¼nmek bile iÃ§imi Ä±sÄ±tÄ±yor. ğŸ§£",
        "Sen benim cennetimsin. ğŸ‘¼", "Kalbimdeki yerin asla dolmayacak. ğŸ•³ï¸", "Sen benim hayat Ä±ÅŸÄ±ÄŸÄ±msÄ±n. ğŸ”¦",
        "Seni sevmek bir ayrÄ±calÄ±k. ğŸ«", "Seninle her ÅŸey mÃ¼mkÃ¼n. ğŸŒŸ", "Sen benim can yoldaÅŸÄ±msÄ±n. ğŸ‘¯",
        "AÅŸkÄ±n beni tamamlÄ±yor. ğŸŒ“", "Sen benim en gÃ¼zel gerÃ§eÄŸimsin. ğŸ¦„", "Seninle bir Ã¶mÃ¼r yetmez bana. â™¾ï¸",
        "Sen benim tek gerÃ§eÄŸimsin. ğŸ“", "AÅŸkÄ±nla dÃ¼nyam deÄŸiÅŸti. ğŸŒ", "Sen benim baharÄ±msÄ±n. ğŸŒ·",
        "Seni sevmek en gÃ¼zel duygu. ğŸ§¸", "Sen benim hayatÄ±mÄ±n baÅŸrolÃ¼sÃ¼n. ğŸ­", "Seninle her ÅŸey daha anlamlÄ±. ğŸ•¯ï¸",
        "AÅŸkÄ±n iÃ§imi titretiyor. ğŸ’“", "Sen benim her halimsin. â˜¯ï¸", "Seni Ã§ok seviyorum. ğŸ’",
        "Sen benim Ã¶mrÃ¼msÃ¼n. ğŸ•°ï¸", "Seninle her gÃ¼n yeni bir macera. ğŸ›¶", "AÅŸkÄ±mÄ±z Ã¶lÃ¼msÃ¼z olsun. ğŸ§›â€â™‚ï¸â¤ï¸",
        "Sen benim kalbimdir. ğŸ«€", "Seni seviyorum, hem de Ã§ok. ğŸ’–âœ¨"
    ];

    const randomIndex = Math.floor(Math.random() * words.length);
    const display = document.getElementById('love-text-display');
    
    // MesajÄ± Kutuda GÃ¶ster
    if(display) {
        display.style.opacity = '0';
        setTimeout(() => {
            display.innerText = words[randomIndex];
            display.style.opacity = '1';
        }, 200);
    }

    // KONFETÄ°LERÄ° PATLAT
    createConfetti();
}

function createConfetti() {
    const colors = ['#ec4899', '#db2777', '#f472b6', '#ffffff', '#ffd700'];
    const shapes = ['â¤ï¸', 'âœ¨', 'ğŸ’–', 'â­', 'ğŸŒ¸'];

    for (let i = 0; i < 35; i++) {
        const confetti = document.createElement('div');
        confetti.innerText = shapes[Math.floor(Math.random() * shapes.length)];
        confetti.style.position = 'fixed';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.top = '-5vh';
        confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.fontSize = (Math.random() * 15 + 15) + 'px';
        confetti.style.zIndex = '10001';
        confetti.style.pointerEvents = 'none';
        confetti.style.transition = `transform ${Math.random() * 2 + 3}s linear, opacity ${Math.random() * 2 + 3}s linear`;
        
        document.body.appendChild(confetti);

        setTimeout(() => {
            confetti.style.transform = `translateY(110vh) translateX(${Math.random() * 200 - 100}px) rotate(${Math.random() * 360}deg)`;
            confetti.style.opacity = '0';
        }, 10);

        setTimeout(() => { confetti.remove(); }, 5000);
    }
}

        function initMap() {
            if (mainMap) return;
            mainMap = L.map('map', { zoomControl: false }).setView([39.2, 28.5], 7);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(mainMap);
            const bursa = [40.1885, 29.0610];
            const odemis = [38.2312, 27.9719]; 
            L.marker(bursa).addTo(mainMap).bindPopup('<b>Melih</b><br>Bursa ğŸ‚');
            L.marker(odemis).addTo(mainMap).bindPopup('<b>Ecem</b><br>Ã–demiÅŸ ğŸº');
            const midLat = (bursa[0] + odemis[0]) / 2 + 0.5;
            const midLon = (bursa[1] + odemis[1]) / 2 + 0.2;
            L.polyline([bursa, [midLat, midLon], odemis], { color: '#3b82f6', weight: 3, opacity: 0.7, dashArray: '10, 10' }).addTo(mainMap);
            const heartIcon = L.divIcon({ className: 'custom-div-icon', html: `<div style="text-align: center;"><span class="beating-heart">â¤ï¸</span><br><span class="map-label">369 KM</span></div>`, iconSize: [80, 60], iconAnchor: [40, 30] });
            L.marker([midLat, midLon], { icon: heartIcon }).addTo(mainMap);
        }

       async function syncVeri() {
    try {
        // Mevcut SCRIPT_URL Ã¼zerinden veri Ã§ekimi (MantÄ±k aynÄ± kaldÄ±)
        // Sonuna eklenen zaman damgasÄ± tarayÄ±cÄ±nÄ±n bayat veri Ã§ekmesini engeller
        const response = await fetch(SCRIPT_URL + "?action=read&t=" + new Date().getTime());
        if (!response.ok) return;
        const remoteData = await response.json();
        
        const stringified = JSON.stringify(remoteData);
        if(stringified === lastSyncData) return;
        lastSyncData = stringified;

        // --- VERÄ°LERÄ° DEÄÄ°ÅTÄ°RMEDEN Ä°ÅLEME ---

        // NOTLAR GÃœNCELLE
        if(remoteData.notes) { 
            localStorage.setItem('notes', JSON.stringify(remoteData.notes)); 
            if(typeof displayLogs === "function") displayLogs(); 
        }

        // PLANLAR GÃœNCELLE
        if(remoteData.goals) { 
            localStorage.setItem('goals', JSON.stringify(remoteData.goals)); 
            if(typeof displayGoals === "function") displayGoals(); 
        }

        // SOHBET GÃœNCELLE
        if(remoteData.chats) { 
            // Sohbetin doÄŸru akmasÄ± iÃ§in gelen veriyi yerel hafÄ±zaya alÄ±yoruz
            localStorage.setItem('chats', JSON.stringify(remoteData.chats)); 
            if(typeof displayChats === "function") displayChats(); 
        }

        // ÅARKILAR GÃœNCELLE
        if(remoteData.songs) {
            localStorage.setItem('song_history', JSON.stringify(remoteData.songs));
            remoteData.songs.forEach(s => { 
                localStorage.setItem('song_' + s.user, s.link); 
            });
            if(typeof loadSongs === "function") loadSongs();
            if(typeof displaySongHistory === "function") displaySongHistory();
        }

        // MODLAR GÃœNCELLE (Mevcut 24 saat ve Zaman korumalÄ± mantÄ±k)
        if(remoteData.moods) {
            const now = new Date().getTime();
            remoteData.moods.forEach(m => { 
                const localTime = localStorage.getItem('mood_time_' + m.user) || 0;
                // Senin kodundaki orijinal zaman kontrolÃ¼:
                if(m.mood && m.time >= localTime) { 
                    localStorage.setItem('mood_' + m.user, m.mood); 
                    localStorage.setItem('mood_time_' + m.user, m.time); 
                }
            });
            if(typeof updateMoodUI === "function") updateMoodUI();
        }

    } catch(e) { 
        console.log("Senkronizasyon hatasÄ±:", e); 
    }

        }

        function toggleQuickMenu() {
            const menu = document.getElementById('quickMenu');
            menu.style.display = menu.style.display === 'grid' ? 'none' : 'grid';
        }

        function sendQuick(msg) {
            document.getElementById('chatInput').value = msg;
            sendChatMessage();
            toggleQuickMenu();
        }

        function sendChatMessage() {
            const val = document.getElementById('chatInput').value;
            if(!val) return;
            const entry = { msg: val, user: selectedUser, time: new Date().getTime() };
            const chats = JSON.parse(localStorage.getItem('chats')) || [];
            chats.push(entry);
            localStorage.setItem('chats', JSON.stringify(chats));
            document.getElementById('chatInput').value = "";
            displayChats();
            sendToExcel(val, "Chat");
        }

        function displayChats() {
            const chats = JSON.parse(localStorage.getItem('chats')) || [];
            const chatBox = document.getElementById('chatBox');
            if(!chatBox) return;
            chatBox.innerHTML = chats.map(c => `
                <div class="msg msg-${c.user}">
                    ${c.msg}
                </div>
            `).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function setUser(name) {
            selectedUser = name;
            localStorage.setItem('active_user', name);
            document.getElementById('identityOverlay').style.display = 'none';
            document.getElementById('step1').classList.remove('hidden');
            sendToExcel("Sisteme GiriÅŸ YaptÄ±", "Log");
            displayChats();
            displayLogs();
            displayGoals();
            loadSongs();
        }

        function sendToExcel(mesaj, tip, ekVeri = "") {
            const entry = { user: selectedUser, tip: tip, mesaj: mesaj, time: new Date().getTime(), ek: ekVeri };
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(entry) });
        }

        function startReset() {
            document.getElementById('step1').classList.add('hidden');
            const term = document.getElementById('terminal');
            term.classList.remove('hidden');
            const lines = ["> BaÄŸlantÄ± kuruluyor...", "> Veriler senkronize ediliyor...", "> Sistem hazÄ±r."];
            let i = 0;
            const intv = setInterval(() => {
                if(i < lines.length) { term.innerHTML += lines[i]+"<br>"; i++; }
                else { clearInterval(intv); setTimeout(() => { term.classList.add('hidden'); document.getElementById('step3').classList.remove('hidden'); initMap(); }, 800); }
            }, 600);
        }

        function startBirthdayTimers() {
        // 225. satÄ±r civarÄ±
updateWeather(); 
setInterval(updateWeather, 900000); // 15 dakikada bir otomatik gÃ¼nceller
            function updateTimer(targetMonth, targetDay, elementId) {
                const now = new Date(); let year = now.getFullYear();
                let bday = new Date(year, targetMonth - 1, targetDay);
                if (now > bday) bday = new Date(year + 1, targetMonth - 1, targetDay);
                const diff = bday - now;
                const d = Math.floor(diff / 86400000);
                const h = Math.floor((diff % 86400000) / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                document.getElementById(elementId).innerText = `${d}g ${h}s ${m}d ${s}s`;
            }
            setInterval(() => { updateTimer(8, 12, 'ecemTimer'); updateTimer(6, 7, 'melihTimer'); }, 1000);
        }

        function selectMood(id) {
            const time = new Date().getTime();
            localStorage.setItem('mood_' + selectedUser, id);
            localStorage.setItem('mood_time_' + selectedUser, time);
            updateMoodUI();
            sendToExcel(id, "Mod GÃ¼ncelleme", time);
        }

        function updateMoodUI() {
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.user-tag').forEach(tag => tag.innerHTML = "");
            const now = new Date().getTime();
            const limit = 86400000;
            ['ecem', 'melih'].forEach(u => {
                const m = localStorage.getItem('mood_' + u);
                const t = localStorage.getItem('mood_time_' + u);
                if(m && t && (now - t < limit)) { 
                    document.getElementById('m-' + m)?.classList.add('active');
                    const tag = document.getElementById('tag-' + m);
                    if(tag) tag.innerHTML += `<span class="${u === 'ecem' ? 'tag-e' : 'tag-m'}">${u}</span>`;
                }
            });
        }

        function updateStreakUI() {
            let streak = parseInt(localStorage.getItem('song_streak')) || 3;
            document.getElementById('streakDisplay').innerText = `GÃ¼ncel Seri ğŸ”¥ ${streak}`;
        }

        function updateSong() {
            const val = document.getElementById('songInput').value;
            if(!val.includes("track")) return;
            
            const now = new Date();
            const todayStr = now.toDateString(); 
            const lastUpdateDate = localStorage.getItem('last_song_date');
            let streak = parseInt(localStorage.getItem('song_streak')) || 3;

            if (lastUpdateDate !== todayStr) {
                streak++;
                localStorage.setItem('song_streak', streak);
                localStorage.setItem('last_song_date', todayStr);
                updateStreakUI();
            }

            localStorage.setItem('song_' + selectedUser, val);
            loadSongs();
            document.getElementById('songInput').value = "";
            sendToExcel(val, "ÅarkÄ±", streak);
        }

        function loadSongs() {
            ['ecem', 'melih'].forEach(u => {
                const song = localStorage.getItem('song_' + u);
                const slot = document.getElementById('spotify-' + u);
                if(song && slot) {
                    const parts = song.split("track/");
                    if(parts.length > 1) {
                        const sid = parts[1].split("?")[0];
                        slot.innerHTML = `<iframe src="https://open.spotify.com/embed/track/${sid}" width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`;
                    }
                }
            });
        }

        function displaySongHistory() {
            const history = JSON.parse(localStorage.getItem('song_history')) || [];
            const container = document.getElementById('songHistory');
            if(container) {
                container.innerHTML = history.slice(0, 5).map(s => `<div class="song-history-item" onclick="window.open('${s.link}', '_blank')">ğŸµ ${s.user.toUpperCase()} paylaÅŸtÄ±...</div>`).join('');
            }
        }

        function sendNote() {
            const val = document.getElementById('noteInput').value;
            if(!val) return;
            const entry = { mesaj: val, tarih: new Date().toLocaleString('tr-TR'), user: selectedUser, tip: "Not" };
            const notes = JSON.parse(localStorage.getItem('notes')) || [];
            notes.unshift(entry);
            localStorage.setItem('notes', JSON.stringify(notes));
            document.getElementById('noteInput').value = "";
            displayLogs();
            sendToExcel(val, "Not");
        }

        function displayLogs() {
            const logs = JSON.parse(localStorage.getItem('notes')) || [];
            const logList = document.getElementById('logList');
            if(logList) {
                logList.innerHTML = logs.map(l => `<div class="item-card"><b>${l.mesaj}</b> <span style="color:${l.user === 'ecem' ? '#ec4899' : '#3b82f6'}; font-size:0.75rem;">(${l.user})</span></div>`).join('');
            }
        }

        function addGoal() {
            const val = document.getElementById('bucketInput').value;
            if(!val) return;
            const entry = { text: val, done: false, user: selectedUser };
            const goals = JSON.parse(localStorage.getItem('goals')) || [];
            goals.push(entry);
            localStorage.setItem('goals', JSON.stringify(goals));
            document.getElementById('bucketInput').value = "";
            displayGoals();
            sendToExcel(val, "Hedef");
        }

        function displayGoals() {
            const goals = JSON.parse(localStorage.getItem('goals')) || [];
            const bucketList = document.getElementById('bucketList');
            if(bucketList) {
                bucketList.innerHTML = goals.map((g, i) => `<div class="item-card"><input type="checkbox" ${g.done ? 'checked' : ''} onclick="toggleGoal(${i})"> ${g.text}</div>`).join('');
            }
        }

        function toggleGoal(i) {
            const goals = JSON.parse(localStorage.getItem('goals'));
            goals[i].done = !goals[i].done;
            localStorage.setItem('goals', JSON.stringify(goals));
            displayGoals();
            sendToExcel(goals[i].text, "Hedef-Tamamla", goals[i].done);
        }

        function copySong(u) {
            const song = localStorage.getItem('song_' + u);
            if(song) { navigator.clipboard.writeText(song); alert(`KopyalandÄ±!`); }
        }

// 1. Ortak Senkronizasyon: BaÅŸka sekmede iÅŸlem yapÄ±ldÄ±ÄŸÄ±nda anÄ±nda gÃ¼ncelle
window.addEventListener('storage', (e) => {
    const keys = ['chats', 'notes', 'goals'];
    if (keys.includes(e.key)) {
        if(typeof displayChats === "function") displayChats();
        if(typeof displayLogs === "function") displayLogs();
        if(typeof displayGoals === "function") displayGoals();
    }
});

// 2. Ana Admin Fonksiyonu
function adminLogin() {
    const id = prompt("Admin ID:");
    const pw = prompt("Åifre:");
    if(id === "melih" && pw === "9999") {
        const action = prompt("1: Silme modunu aÃ§/kapat\n2: TÃ¼m verileri SORGUSUZ sÄ±fÄ±rla");
        
        if(action === "1") {
            document.body.classList.toggle('admin-active');
            const isActive = document.body.classList.contains('admin-active');
            // KullanÄ±cÄ±yÄ± bekletmemek iÃ§in alert yerine konsola yazÄ±yoruz
            console.log(isActive ? "Silme modu aktif" : "KapatÄ±ldÄ±");
            
            // EkranÄ± tazele ki butonlar gelsin/gitsin
            if(typeof displayChats === "function") displayChats();
            if(typeof displayLogs === "function") displayLogs();
            if(typeof displayGoals === "function") displayGoals();
        } else if(action === "2") {
            // Soru sormadan direkt temizler
            localStorage.clear(); 
            location.reload(); 
        }
    } else {
        alert("HatalÄ± giriÅŸ!");
    }
}

// 3. HÄ±zlÄ± Silme: Onay mekanizmasÄ± tamamen kaldÄ±rÄ±ldÄ±
function deleteItem(storageKey, index, refreshFunc) {
    let data = JSON.parse(localStorage.getItem(storageKey)) || [];
    data.splice(index, 1);
    localStorage.setItem(storageKey, JSON.stringify(data));
    
    if(typeof sendToExcel === "function") {
        sendToExcel("Ã–ÄŸe Silindi", "Admin-Panel", storageKey);
    }
    
    // UI GÃ¼ncelleme
    refreshFunc();
}

// --- OTOMATÄ°K BUTON EKLEME SÄ°STEMÄ° ---

// Sohbetler iÃ§in
const originalDisplayChats = window.displayChats;
window.displayChats = function() {
    if(typeof originalDisplayChats === "function") originalDisplayChats();
    if(document.body.classList.contains('admin-active')) {
        document.querySelectorAll('.msg').forEach((msg, i) => {
            if(!msg.querySelector('.admin-del')) {
                const btn = document.createElement('button');
                btn.innerHTML = 'Ã—';
                btn.className = 'admin-del';
                btn.style = "background:#ff4d4d; color:white; border:none; border-radius:4px; width:18px; height:18px; cursor:pointer; float:right; font-weight:bold; margin-left:5px;";
                btn.onclick = (e) => { e.stopPropagation(); deleteItem('chats', i, displayChats); };
                msg.prepend(btn);
            }
        });
    }
};

// Notlar (Loglar) iÃ§in
const originalDisplayLogs = window.displayLogs;
window.displayLogs = function() {
    if(typeof originalDisplayLogs === "function") originalDisplayLogs();
    if(document.body.classList.contains('admin-active')) {
        document.querySelectorAll('#logList .item-card').forEach((item, i) => {
            if(!item.querySelector('.admin-del')) {
                const btn = document.createElement('button');
                btn.innerHTML = 'SÄ°L';
                btn.className = 'admin-del';
                btn.style = "background:#ff4d4d; color:white; border:none; border-radius:4px; padding:2px 8px; cursor:pointer; float:right; font-size:10px; font-weight:bold;";
                btn.onclick = (e) => { e.stopPropagation(); deleteItem('notes', i, displayLogs); };
                item.prepend(btn);
            }
        });
    }
};

// Planlar (Hedefler) iÃ§in
const originalDisplayGoals = window.displayGoals;
window.displayGoals = function() {
    if(typeof originalDisplayGoals === "function") originalDisplayGoals();
    if(document.body.classList.contains('admin-active')) {
        document.querySelectorAll('#bucketList .item-card').forEach((item, i) => {
            if(!item.querySelector('.admin-del')) {
                const btn = document.createElement('button');
                btn.innerHTML = 'SÄ°L';
                btn.className = 'admin-del';
                btn.style = "background:#ff4d4d; color:white; border:none; border-radius:4px; padding:2px 8px; cursor:pointer; float:right; font-size:10px; font-weight:bold;";
                btn.onclick = (e) => { e.stopPropagation(); deleteItem('goals', i, displayGoals); };
                item.prepend(btn);
            }
        });
    }
};
    </script>
</body>
</html>
